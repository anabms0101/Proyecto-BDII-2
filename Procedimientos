CREATE OR REPLACE PROCEDURE insertar_cliente(store_id INT, nombre TEXT, apellido TEXT, email TEXT, address_id INT, active INT)
LANGUAGE plpgsql
AS $$
BEGIN
    IF EXISTS (SELECT 1 FROM store s WHERE s.store_id = insertar_cliente.store_id) THEN
        INSERT INTO customer(store_id, first_name, last_name, email, address_id, active)
        VALUES (insertar_cliente.store_id, nombre, apellido, email, address_id, active);
        RAISE NOTICE 'El cliente se ha insertado correctamente :)';
    ELSE
        RAISE NOTICE 'No se pudo ingresar el cliente: store_id % no existe.', store_id;
    END IF;
END;
$$;



CREATE OR REPLACE PROCEDURE registrar_alquiler(inventory_id int, nombre text, apellido text, staff_id int)
LANGUAGE plpgsql
AS $$
DECLARE
    cust_id int;
BEGIN
	select customer_id into cust_id from customer where first_name = nombre and last_name = apellido;
    INSERT INTO rental(inventory_id, customer_id, staff_id)
    VALUES (inventory_id, cust_id, staff_id);
END;
$$;


CREATE OR REPLACE PROCEDURE registrar_devolucion(rental_id int, return_date date)
LANGUAGE plpgsql
AS $$
BEGIN
    UPDATE rental
    SET return_date = return_date
    WHERE rental.rental_id = rental_id;
END;
$$;



CREATE OR REPLACE FUNCTION buscar_pelicula(titulo TEXT)
RETURNS TEXT
SECURITY DEFINER
LANGUAGE plpgsql
AS $$
DECLARE
    mensaje TEXT;
    id1 INT;
    descr TEXT;
    anio INT;
BEGIN
    SELECT film_id, description, release_year
    INTO id1, descr, anio
    FROM film
    WHERE title = titulo;

    mensaje := 'El id de este film es: ' || id1 || ', ' || descr || ', su a√±o de lanzamiento es: ' || anio;

    RETURN mensaje;
END;
$$;



create role EMP;
grant execute on procedure registrar_alquiler to EMP;
grant execute on procedure registrar_devolucion to EMP;
grant execute on function buscar_pelicula to EMP;
